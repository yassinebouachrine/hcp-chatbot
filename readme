

python -c "from src.data_processor import HCPDataProcessor; from config import Config; proc = HCPDataProcessor(Config); data = proc.load_all_data(); qa_pairs = proc.create_qa_pairs(); print(f'âœ… DonnÃ©es prÃ©parÃ©es: {len(qa_pairs)} paires QA prÃªtes pour entraÃ®nement'); stats = proc.get_statistics(); print(f'ğŸ“Š Territoires: {len(stats.get(\"territories\", {}))}, Types: {len(stats.get(\"question_types\", {}))}, Indicateurs: {len(stats.get(\"indicators\", {}))}'); proc.analyze_data_coverage()"



python -c "from src.data_processor import HCPDataProcessor; from src.model_trainer import HCPChatbotTrainer; from config import Config; proc = HCPDataProcessor(Config); data = proc.load_all_data(); qa_pairs = proc.create_qa_pairs(); trainer = HCPChatbotTrainer(Config); trainer.train_model(qa_pairs, use_validation=True, force_use_all_data=True); print('ğŸ¯ EntraÃ®nement terminÃ©!')"










# HCP Chatbot - DÃ©ploiement Docker

Ce guide vous explique comment dÃ©ployer votre chatbot HCP (Haut-Commissariat au Plan) spÃ©cialisÃ© dans les donnÃ©es dÃ©mographiques du Maroc en utilisant Docker.

## ğŸ“‹ PrÃ©requis

- Docker installÃ© (version 20.10+)
- docker-compose installÃ© (version 1.29+)
- Au moins 4GB de RAM disponible
- Fichier `data/indicators.json` avec la structure HCP qa_pairs

## ğŸ—ï¸ Structure du projet

```
HCP-CHATBOT/
â”œâ”€â”€ app.py                    # Application Flask principale
â”œâ”€â”€ config.py                 # Configuration HCP (votre fichier existant)
â”œâ”€â”€ requirements.txt          # DÃ©pendances Python
â”œâ”€â”€ Dockerfile               # Image Docker
â”œâ”€â”€ docker-compose.yml       # Orchestration des services
â”œâ”€â”€ .dockerignore           # Fichiers Ã  ignorer
â”œâ”€â”€ .env.template           # Template de configuration
â”œâ”€â”€ build_and_run.sh        # Script de dÃ©marrage automatique
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ indicators.json      # ğŸ“Š DonnÃ©es HCP avec structure qa_pairs
â”‚   â””â”€â”€ conversation_history.json
â”œâ”€â”€ models/
â”‚   â””â”€â”€ models_hcp/         # ModÃ¨les prÃ©-entraÃ®nÃ©s
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ chatbot.py          # Votre chatbot HCP
â”‚   â”œâ”€â”€ data_processor.py   # Processeur de donnÃ©es HCP
â”‚   â””â”€â”€ ...
â”œâ”€â”€ templates/
â”‚   â””â”€â”€ index.html          # Interface web
â””â”€â”€ static/
    â”œâ”€â”€ css/
    â”œâ”€â”€ js/
    â””â”€â”€ images/
```

## ğŸš€ DÃ©marrage rapide

### 1. PrÃ©paration

```bash
# Copier le template de configuration
cp .env.template .env

# Ã‰diter la configuration si nÃ©cessaire
nano .env

# VÃ©rifier que vos donnÃ©es HCP sont prÃ©sentes
ls -la data/indicators.json
```

### 2. Lancement automatique

```bash
# Rendre le script exÃ©cutable
chmod +x build_and_run.sh

# Lancer le chatbot HCP
./build_and_run.sh
```

### 3. Lancement manuel

```bash
# Construire l'image
docker-compose build

# DÃ©marrer les services
docker-compose up -d

# VÃ©rifier les logs
docker-compose logs -f
```

## ğŸ”§ Configuration

### Variables d'environnement (.env)

| Variable | DÃ©faut | Description |
|----------|--------|-------------|
| `FLASK_HOST` | `0.0.0.0` | Host Flask pour Docker |
| `FLASK_PORT` | `5000` | Port d'Ã©coute Flask |
| `FLASK_DEBUG` | `False` | Mode debug (production: False) |
| `HUGGING_FACE_TOKEN` | `` | Token HF pour modÃ¨les privÃ©s |
| `USE_CUDA` | `False` | Utiliser GPU (nÃ©cessite nvidia-docker) |
| `FP16` | `False` | PrÃ©cision mixte pour GPU |
| `LOG_LEVEL` | `INFO` | Niveau de logging |
| `BATCH_SIZE` | `64` | Taille de batch (ajuster selon RAM) |
| `SIMILARITY_THRESHOLD` | `0.75` | Seuil de similaritÃ© HCP |
| `MAX_LENGTH` | `96` | Longueur max des sÃ©quences |
| `TEMPERATURE` | `0.3` | TempÃ©rature de gÃ©nÃ©ration |

### Configuration HCP spÃ©cialisÃ©e

Votre `config.py` contient des configurations optimisÃ©es pour :
- **DonnÃ©es dÃ©mographiques HCP Maroc** avec 140,000+ statistiques
- **Structure qa_pairs moderne** pour questions-rÃ©ponses
- **2000+ territoires marocains** avec indicateurs prÃ©cis
- **Mappage d'indicateurs HCP** (population, matrimonial, Ã¢ge, emploi, etc.)
- **RÃ©ponses contextuelles** adaptÃ©es aux donnÃ©es officielles

## ğŸ§ª Tests et vÃ©rification

### Endpoints disponibles

| Endpoint | MÃ©thode | Description | Exemple |
|----------|---------|-------------|---------|
| `/` | GET | Interface web principale | http://localhost:5000 |
| `/health` | GET | Statut de santÃ© du systÃ¨me | http://localhost:5000/health |
| `/chat` | POST | API de chat HCP | Voir exemple ci-dessous |
| `/territories` | GET | Liste des territoires HCP | http://localhost:5000/territories |

### Tester l'API Chat

```bash
# Test basique
curl -X POST http://localhost:5000/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "Population du Maroc"}'

# Test avec territoire spÃ©cifique
curl -X POST http://localhost:5000/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "Population lÃ©gale de Casablanca"}'

# Test avec indicateur dÃ©mographique
curl -X POST http://localhost:5000/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "Pourcentage de mariÃ©s au niveau national"}'
```

### Exemple de rÃ©ponse API

```json
{
  "response": "La population lÃ©gale du Maroc (Ensemble du territoire national) est de 33 848 242 habitants selon les derniÃ¨res donnÃ©es HCP.",
  "status": "success",
  "metadata": {
    "model_used": "semantic_search",
    "qa_pairs_count": 140567,
    "response_method": "semantic_search",
    "territory_detected": "Ensemble du territoire national",
    "indicator_detected": "population_legale",
    "is_greeting": false
  }
}
```

## ğŸ” Monitoring et logs

### Voir les logs en temps rÃ©el
```bash
# Tous les logs
docker-compose logs -f

# Logs spÃ©cifiques au chatbot
docker-compose logs -f hcp-chatbot
```

### VÃ©rifier la santÃ© du systÃ¨me
```bash
curl http://localhost:5000/health
```

RÃ©ponse attendue :
```json
{
  "status": "healthy",
  "chatbot_initialized": true,
  "data_loaded": true,
  "data_count": 140567,
  "qa_pairs_count": 140567,
  "is_trained": false,
  "has_embeddings": true
}
```

## ğŸ¯ Optimisation des performances

### Ajustement selon votre machine

**Machine avec peu de RAM (< 8GB) :**
```env
BATCH_SIZE=32
DATALOADER_NUM_WORKERS=1
MAX_LENGTH=64
USE_CUDA=False
```

**Machine performante (16GB+ RAM) :**
```env
BATCH_SIZE=128
DATALOADER_NUM_WORKERS=4
MAX_LENGTH=128
USE_CUDA=True  # Si GPU disponible
```

**Machine avec GPU :**
```bash
# Installer nvidia-docker d'abord
# Puis modifier docker-compose.yml pour ajouter :
services:
  hcp-chatbot:
    runtime: nvidia
    environment:
      - USE_CUDA=True
      - FP16=True
```

### Surveillance des ressources
```bash
# Utilisation CPU/RAM du conteneur
docker stats hcp-chatbot-app

# Utilisation dÃ©taillÃ©e
docker-compose exec hcp-chatbot htop
```

## ğŸ› ï¸ Maintenance

### Mise Ã  jour des donnÃ©es HCP
```bash
# Copier nouvelles donnÃ©es
cp nouveau_indicators.json data/indicators.json

# RedÃ©marrer pour recharger
docker-compose restart
```

### Mise Ã  jour du code
```bash
# Reconstruire l'image
docker-compose build --no-cache

# RedÃ©ployer
docker-compose up -d
```

### Sauvegarde des donnÃ©es
```bash
# CrÃ©er une sauvegarde
docker-compose exec hcp-chatbot tar -czf /tmp/hcp_backup.tar.gz /app/data /app/models

# RÃ©cupÃ©rer la sauvegarde
docker cp hcp-chatbot-app:/tmp/hcp_backup.tar.gz ./backups/
```

## ğŸ› DÃ©pannage

### ProblÃ¨mes courants

**Le conteneur ne dÃ©marre pas :**
```bash
# VÃ©rifier les logs
docker-compose logs hcp-chatbot

# VÃ©rifier la configuration
docker-compose config
```

**DonnÃ©es HCP non trouvÃ©es :**
```bash
# VÃ©rifier la prÃ©sence du fichier
docker-compose exec hcp-chatbot ls -la /app/data/

# VÃ©rifier la structure JSON
docker-compose exec hcp-chatbot python -c "import json; print(json.load(open('/app/data/indicators.json')).keys())"
```

**Performance lente :**
- RÃ©duire `BATCH_SIZE` dans `.env`
- RÃ©duire `DATALOADER_NUM_WORKERS`
- VÃ©rifier que `USE_CUDA=False` si pas de GPU

**Erreurs de mÃ©moire :**
```bash
# Augmenter la limite mÃ©moire Docker
docker-compose up -d --memory 6g
```

### Commandes de diagnostic
```bash
# AccÃ©der au conteneur
docker-compose exec hcp-chatbot bash

# Tester la configuration HCP
docker-compose exec hcp-chatbot python config.py

# VÃ©rifier les modules Python
docker-compose exec hcp-chatbot pip list

# Tester l'import des modules HCP
docker-compose exec hcp-chatbot python -c "from src.chatbot import HCPChatbotAdapted; print('OK')"
```

## ğŸ“Š DonnÃ©es HCP supportÃ©es

Le systÃ¨me est optimisÃ© pour traiter :

- **Population lÃ©gale et municipale** par territoire
- **RÃ©partition par Ã¢ge** (tranches d'Ã¢ge dÃ©taillÃ©es)
- **Indicateurs matrimoniaux** (cÃ©libataires, mariÃ©s, divorcÃ©s, veufs)
- **RÃ©partition par genre** (masculin/fÃ©minin)
- **DonnÃ©es d'emploi** (population active, chÃ´mage)
- **Indicateurs d'Ã©ducation** (scolarisation)
- **DonnÃ©es des mÃ©nages** (taille moyenne)
- **Informations de logement**

### Exemples de questions supportÃ©es

- "Quelle est la population lÃ©gale du Maroc ?"
- "Pourcentage de mariÃ©s dans la rÃ©gion de Casablanca"
- "Population masculine de 25-29 ans au niveau national"
- "Taux de scolarisation Ã  Rabat"
- "Nombre de cÃ©libataires Ã  Marrakech"

## ğŸ”— IntÃ©gration

### Utiliser l'API dans votre application

```python
import requests

# Fonction helper pour interroger le chatbot HCP
def ask_hcp_chatbot(question):
    response = requests.post(
        "http://localhost:5000/chat",
        json={"message": question},
        headers={"Content-Type": "application/json"}
    )
    return response.json()

# Exemple d'utilisation
result = ask_hcp_chatbot("Population lÃ©gale de FÃ¨s")
print(result["response"])
```

### IntÃ©gration avec d'autres services
```bash
# Utiliser en tant que microservice
docker network create hcp-network
docker-compose up -d
# Vos autres services peuvent maintenant communiquer via hcp-chatbot:5000
```

## ğŸ“ˆ Monitoring avancÃ©

Pour un monitoring en production, considÃ©rez l'ajout de :

- **Prometheus + Grafana** pour mÃ©triques
- **ELK Stack** pour logs centralisÃ©s  
- **Health checks** automatisÃ©s
- **Alerting** sur pannes systÃ¨me

## ğŸ¤ Support

En cas de problÃ¨me :
1. VÃ©rifiez les logs : `docker-compose logs -f`
2. Validez votre configuration : `python config.py`
3. Testez l'endpoint de santÃ© : `curl http://localhost:5000/health`
4. VÃ©rifiez vos donnÃ©es HCP : structure qa_pairs correcte

---

**ğŸ¯ Votre chatbot HCP est maintenant prÃªt Ã  traiter les questions sur les donnÃ©es dÃ©mographiques officielles du Maroc !**